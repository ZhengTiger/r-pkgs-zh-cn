<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="description" content="Learn how to create a package, the fundamental unit of shareable, reusable, and reproducible R code.">
<title>R Packages (2e) - 3&nbsp; Package structure and state</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./workflow101.html" rel="next">
<link href="./setup.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script defer="" data-domain="r-pkgs.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Package structure and state</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R Packages (2e)</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/zhenghu159/r-pkgs-zh-cn" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle sidebar-tool" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Welcome!</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./introduction.html" class="sidebar-item-text sidebar-link">Introduction</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Getting started</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./whole-game.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">The Whole Game</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./setup.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">System setup</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./structure.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Package structure and state</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow101.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Fundamental development workflows</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./package-within.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">The package within</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Package components</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./code.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">R code</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./misc.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Other components</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">Package metadata</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./description.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title"><code>DESCRIPTION</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dependencies-mindset-background.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Dependencies: Mindset and Background</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dependencies-in-practice.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Dependencies: In Practice</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./license.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Licensing</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">Testing</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./testing-basics.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Testing basics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./testing-design.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Designing your test suite</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./testing-advanced.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Advanced testing techniques</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">Documentation</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./man.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Function documentation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./vignettes.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Vignettes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./other-markdown.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Other markdown files</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./website.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Website</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">Maintenance and distribution</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./software-development-practices.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Software development practices</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lifecycle.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Lifecycle</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./release.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Releasing to CRAN</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">Appendices</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./R-CMD-check.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title"><code>R CMD check</code></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#sec-package-states" id="toc-sec-package-states" class="nav-link active" data-scroll-target="#sec-package-states"><span class="toc-section-number">3.1</span>  Package states</a></li>
  <li><a href="#sec-source-package" id="toc-sec-source-package" class="nav-link" data-scroll-target="#sec-source-package"><span class="toc-section-number">3.2</span>  Source package</a></li>
  <li>
<a href="#sec-bundled-package" id="toc-sec-bundled-package" class="nav-link" data-scroll-target="#sec-bundled-package"><span class="toc-section-number">3.3</span>  Bundled package</a>
  <ul class="collapse">
<li><a href="#sec-rbuildignore" id="toc-sec-rbuildignore" class="nav-link" data-scroll-target="#sec-rbuildignore"><span class="toc-section-number">3.3.1</span>  <code>.Rbuildignore</code></a></li>
  </ul>
</li>
  <li><a href="#sec-structure-binary" id="toc-sec-structure-binary" class="nav-link" data-scroll-target="#sec-structure-binary"><span class="toc-section-number">3.4</span>  Binary package</a></li>
  <li><a href="#sec-installed-package" id="toc-sec-installed-package" class="nav-link" data-scroll-target="#sec-installed-package"><span class="toc-section-number">3.5</span>  Installed package</a></li>
  <li><a href="#in-memory-package" id="toc-in-memory-package" class="nav-link" data-scroll-target="#in-memory-package"><span class="toc-section-number">3.6</span>  In-memory package</a></li>
  <li><a href="#sec-library" id="toc-sec-library" class="nav-link" data-scroll-target="#sec-library"><span class="toc-section-number">3.7</span>  Package libraries</a></li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/zhenghu159/r-pkgs-zh-cn/edit/main/structure.Rmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/zhenghu159/r-pkgs-zh-cn/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-package-structure-state" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Package structure and state</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><div class="cell">

</div>
<p>本章将通过把您从使用 R 包中获得的隐性知识转换为创建和修改它们所需的显式知识，从而开始开发程序包。 您将了解程序包（package）的各种状态，以及它和库（library）之间的区别（以及为什么要关心二者的区别）。</p>
<section id="sec-package-states" class="level2" data-number="3.1"><h2 data-number="3.1" class="anchored" data-anchor-id="sec-package-states">
<span class="header-section-number">3.1</span> Package states</h2>
<p>当你创建或修改一个包时，需要在它的源代码（“source code”）或源文件（“source files”）上进行。 您能够以源代码（<strong>source</strong>）的形式与正在开发的程序包进行交互。 这不是您在日常使用中最熟悉的包形式。 如果您了解 R 程序包可能处于的五种状态，那么程序包开发的工作流将变得更有意义：</p>
<ul>
<li>源代码（source）</li>
<li>捆绑的（bundled）</li>
<li>二进制文件（binary）</li>
<li>已安装的（installed）</li>
<li>载入内存中的（in-memory）</li>
</ul>
<p>您已经知道一些将程序包转入这些状态的函数。 例如，<code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages()</a></code> 可以将包从源码（source）、捆绑（bundled）或二进制（binary）状态移动到已安装（installed）状态。 <code><a href="https://remotes.r-lib.org/reference/install_github.html">devtools::install_github()</a></code> 获取 GitHub 上的源码（source）包并将其移至已安装（installed）状态。 <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> 函数的作用是：将已安装的程序包加载到内存中，以便可以马上直接使用。</p>
</section><section id="sec-source-package" class="level2" data-number="3.2"><h2 data-number="3.2" class="anchored" data-anchor-id="sec-source-package">
<span class="header-section-number">3.2</span> Source package</h2>
<p>一个源码（<strong>source</strong>）程序包就是一个有着特定结构的文件目录。 它包含特定的组件，例如一个 <code>DESCRIPTION</code> 文件、包含 <code>.R</code> 文件的 <code>R/</code> 目录等。 本书余下的大部分章节都致力于详细说明这些组成部分。</p>
<p>如果您刚刚接触 R 程序包的开发，那么您可能从未见过源码（source）形式的程序包！ 您的计算机上可能甚至没有任何源码程序包。 以源码形式查看程序包的最简单的方法是在 web 上浏览其代码。</p>
<p>许多 R 程序包是在 GitHub（或者 GitLab 以及类似的平台）上的公开库中开发的。 最好的方案是访问程序包的 CRAN 主页，例如：</p>
<ul>
<li>forcats: <a href="https://cran.r-project.org/package=forcats" class="uri">https://cran.r-project.org/package=forcats</a>
</li>
<li>readxl: <a href="https://cran.r-project.org/package=readxl" class="uri">https://cran.r-project.org/package=readxl</a>
</li>
</ul>
<p>并且其中一个网页链接（URLs）链接到公共托管服务上的存储库（repository），例如：</p>
<ul>
<li>forcats: <a href="https://github.com/tidyverse/forcats" class="uri">https://github.com/tidyverse/forcats</a>
</li>
<li>readxl: <a href="https://github.com/tidyverse/readxl" class="uri">https://github.com/tidyverse/readxl</a>
</li>
</ul>
<p>即使程序包是在公共存储库中开发的，一些维护人员还是忘记了列出这个网页链接（URL），但是您仍然可以通过搜索来发现它。</p>
<p>即使程序包不是在公共平台上开发的，也可以在 <a href="https://docs.r-hub.io/#cranatgh">unofficial, read-only mirror maintained by R-hub</a> 中访问其源代码。 示例：</p>
<ul>
<li>MASS: <a href="https://github.com/cran/MASS" class="uri">https://github.com/cran/MASS</a>
</li>
<li>car: <a href="https://github.com/cran/car" class="uri">https://github.com/cran/car</a>
</li>
</ul>
<p>请注意，在 <code>cran</code> GitHub 组织内探索包的源码和历史记录与探索包的真正开发场所不同，因为此源码及其演变只是从包的 CRAN 版本进行逆向工程。 它提供了对程序包及其开发历史的审查视图，但根据定义，源代码及其历史包含了所有程序包开发的必需的内容。</p>
</section><section id="sec-bundled-package" class="level2" data-number="3.3"><h2 data-number="3.3" class="anchored" data-anchor-id="sec-bundled-package">
<span class="header-section-number">3.3</span> Bundled package</h2>
<p>捆绑的（<strong>bundled</strong>）程序包是被压缩成单个文件的程序包。 按照惯例（该惯例来自 Linux），R 中的捆绑程序包使用 <code>.tar.gz</code> 扩展名，并且有时被称为源码压缩包（“source tarballs”）。 这意味着多个文件已经被打包为一个文件（<code>.tar</code>）并使用 gzip（<code>.gz</code>）进行压缩。 虽然捆绑程序包本身并不那么有用，但它是源码包和已安装包之间平台无关的、便于传输的中间媒介。</p>
<p>在从本地开发的程序包中生成捆绑程序包这种罕见的情况下，请使用 <code><a href="https://devtools.r-lib.org/reference/build.html">devtools::build()</a></code>。 在幕后，它会调用 <code><a href="https://pkgbuild.r-lib.org/reference/build.html">pkgbuild::build()</a></code> 并最终调用 <code>R CMD build</code>，这些会在 <a href="https://cran.r-project.org/doc/manuals/R-exts.html">Writing R Extensions</a> 的 <a href="https://cran.r-project.org/doc/manuals/R-exts.html#Building-package-tarballs">Building package tarballs</a> 部分中进一步阐述。</p>
<p>这应该会提醒您，捆绑程序包或源码压缩包不仅仅是对源文件进行 tar 打包存档，然后使用 gzip 压缩的结果。 按照惯例，在 R 世界中，在制作 <code>.tar.gz</code> 文件时还要执行一些操作。 这就是我们选择将其称为捆绑（<strong>bundle</strong>）程序包的原因。</p>
<p>每个 CRAN 包都可以通过其登陆页面的 “Package source” 字段以捆绑（bundled）形式提供。 继续我们上面的示例，您可以下载 <code>forcats_0.4.0.tar.gz</code> 和 <code>readxl_1.3.1.tar.gz</code> 的捆绑包（或者任何当前的版本）。 您可以在 shell（而不是 R 控制台）中进行解压缩：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> xvf forcats_0.4.0.tar.gz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>如果您解压缩一个捆绑包，您将看到它看起来几乎与源码包相同。 <a href="#fig-package-files">Figure&nbsp;<span>3.1</span></a> 显示了名为 zzzpackage 的虚构包的源码（source）、捆绑（bundled）、二进制（binary）形式的文件。 我们特意制作了这个示例，以包含本书中涵盖的大部分包部分。 并非每个包都包含此处看到的每个文件，此图也不包含可能出现在包中的每个可能文件。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-package-files" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="diagrams/package-files.png" class="img-fluid figure-img" alt="Side-by-side comparison of source, bundled, and binary package. The flow of files (location and format) from package source to bundled to binary state is shown. This is described in detail in the appropriately named sections of this chapter." width="1360"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;3.1: Package forms: source vs.&nbsp;bundled vs.&nbsp;binary.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>源码（source）包和未压缩的捆绑（bundle）包之间的主要区别为：</p>
<ul>
<li><p>已经生成了 Vignettes，因此以已渲染的输出（如 HTML）出现在 <code>inst/doc/</code> 目录下，并且 Vignette 索引出现在 <code>build/</code> 目录中。</p></li>
<li><p>本地源码包可能包含用于在开发期间节省时间的临时文件，如 <code>src/</code> 中的编译文件。 这些文件从来没有在捆绑包中找到过。</p></li>
<li><p><code>.Rbuildignore</code> 中列出的任何文件都不包含在捆绑包中。 这些文件通常有助于您的开发过程，但应该从分发式的产品中排除。</p></li>
</ul>
<section id="sec-rbuildignore" class="level3" data-number="3.3.1"><h3 data-number="3.3.1" class="anchored" data-anchor-id="sec-rbuildignore">
<span class="header-section-number">3.3.1</span> <code>.Rbuildignore</code>
</h3>
<p>您不需要非常频繁地考虑 <code>.tar.gz</code> 文件形式的程序包的确切结构，但您确实需要了解 <code>.Rbuildignore</code> 文件。 它决定了源码包中的哪些文件可以进入后面的工作流。</p>
<p><code>.Rbuildignore</code> 的每一行都是与 Perl 兼容的正则表达式，不考虑大小写，它与源码包中每个文件的路径匹配<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>。 如果与正则表达式匹配，则排除该文件或目录。 注意，有一些默认排除项由 R 本身执行，主要与经典的版本控制系统和编辑器（如 SVN、Git 和 Emacs）有关。</p>
<p>我们通常使用 <code><a href="https://usethis.r-lib.org/reference/use_build_ignore.html">usethis::use_build_ignore()</a></code> 函数修改 <code>.Rbuildignore</code>，它负责处理容易忘记的细节，例如正则表达式锚定和转义。 要排除特定文件或目录（最常见的使用示例），您必须锚定（anchor）正则表达式。 例如，要排除名为 “notes” 的目录，<code>.Rbuildignore</code> 条目必须是 <code>^notes$</code>，而未锚定的正则表达式 <code>notes</code> 将匹配任何包含 “notes” 的文件名，例如 <code>R/notes.R</code>、<code>man/important-notes.R</code>、<code>data/endnotes.Rdata</code> 等。 我们发现 <code><a href="https://usethis.r-lib.org/reference/use_build_ignore.html">use_build_ignore()</a></code> 可以帮助我们一次性获得更多的 <code>.Rbuildignore</code> 条目。</p>
<p><code>.Rbuildignore</code> 是解决让您更便利地开发的操作与 CRAN 提交和分发的要求之间一些紧张关系的一种方法 (<a href="release.html"><span>Chapter&nbsp;22</span></a>)。 即使您不打算在 CRAN 上发布，遵循这些约定能让您最好地使用 R 的内置工具来检查和安装程序包。 你应该 <code>.Rbuildignore</code> 的文件分为两个广泛的、半重叠的类别：</p>
<ul>
<li>帮助您以编程方式生成程序包内容的文件。例如：
<ul>
<li>使用 <code>README.Rmd</code> 生成信息丰富的最新 <code>README.md</code>（<a href="other-markdown.html#sec-readme"><span>Section&nbsp;18.1</span></a>）。</li>
<li>存储 <code>.R</code> 脚本以创建和更新内部或导出数据（<a href="data.html#sec-data-data-raw"><span>Section&nbsp;7.1.1</span></a>）。</li>
</ul>
</li>
<li>驱动程序包开发、检查和产生文档的文件，不在 CRAN 的范围内。例如：
<ul>
<li>与 RStudio IDE 相关的文件（<a href="workflow101.html#sec-workflow101-rstudio-projects"><span>Section&nbsp;4.2</span></a>）。</li>
<li>使用 <a href="https://pkgdown.r-lib.org/">pkgdown package</a> 生成网站（<a href="website.html"><span>Chapter&nbsp;19</span></a>）。</li>
<li>与持续集成/部署相关的配置文件（<a href="software-development-practices.html#sec-sw-dev-practices-ci"><span>Section&nbsp;20.2</span></a>）。</li>
</ul>
</li>
</ul>
<p>以下是 tidyverse 中程序包的 <code>.Rbuildignore</code> 文件中典型条目的非完整列表：</p>
<pre><code>^.*\.Rproj$         # Designates the directory as an RStudio Project
^\.Rproj\.user$     # Used by RStudio for temporary files
^README\.Rmd$       # An Rmd file used to generate README.md
^LICENSE\.md$       # Full text of the license
^cran-comments\.md$ # Comments for CRAN submission
^data-raw$          # Code used to create data included in the package
^pkgdown$           # Resources used for the package website
^_pkgdown\.yml$     # Configuration info for the package website
^\.github$          # GitHub Actions workflows</code></pre>
<p>请注意，上面的注释不能出现在实际的 <code>.Rbuildignore</code> 文件中；此处包含这些注释只是为了演示。</p>
<p>我们会在需要的时候提到何时需要向 <code>.Rbuildignore</code> 中添加排除项。 请记住 <code><a href="https://usethis.r-lib.org/reference/use_build_ignore.html">usethis::use_build_ignore()</a></code> 是管理此文件的一种有吸引力的方法。 此外，许多使用此功能添加应在 <code>.Rbuildignore</code> 中列出的文件会自动处理此问题。 例如，<code>use_read_rmd()</code> 将 “^README\.Rmd$” 添加到 <code>.Rbuildignore</code>。</p>
</section></section><section id="sec-structure-binary" class="level2" data-number="3.4"><h2 data-number="3.4" class="anchored" data-anchor-id="sec-structure-binary">
<span class="header-section-number">3.4</span> Binary package</h2>
<p>如果要将程序包分发给没有程序包开发工具的 R 用户，则需要提供二进制（<strong>binary</strong>）包。 二进制包的主要制造者和分发者是 CRAN，而不是个人维护者。 但是，即使您将分发包的责任委托给 CRAN，维护者了解二进制包的性质仍然很重要。</p>
<p>与捆绑包一样，二进制包是单个文件。 与捆绑包不同，二进制包是特定于平台的，有两种基本风格：Windows 和 macOS。 （Linux 用户通常需要拥有从 <code>.tar.gz</code> 文件安装所需的工具，尽管像 <a href="https://packagemanager.posit.co/">Posit Public Package Manager</a> 这样的资源的出现让 Linux 用户可以像他们在 Windows 和 macOS 上的同事一样访问二进制包。）</p>
<p>macOS 的二进制包存储为 <code>.tgz</code>，而 Windows 二进制包以 <code>.zip</code> 结尾。 如果需要制作二进制包，请在相关操作系统上使用 <code>devtools::build(binary = TRUE)</code>。 在幕后，这会调用 <code>pkgbuild::build(binary = TRUE)</code> 并最终调用 <code>R CMD INSTALL --build</code>，这在 <a href="https://cran.r-project.org/doc/manuals/R-exts.html">Writing R Extensions</a> 的 <a href="https://cran.r-project.org/doc/manuals/R-exts.html#Building-binary-packages">Building binary packages</a> 部分中有进一步描述。 如果你选择在 CRAN 上发布你的包（<a href="release.html"><span>Chapter&nbsp;22</span></a>），你以捆绑形式提交你的包，然后 CRAN 创建并分发包二进制文件。</p>
<p>不论是 macOS 或 Windows，还是 R 的当前、先前和（可能的）开发版本，CRAN 通常都能以二进制包形式提供。 继续我们上面的例子，您能够下载二进制包，例如：</p>
<ul>
<li>forcats for macOS: <code>forcats_0.4.0.tgz</code>
</li>
<li>readxl for Windows: <code>readxl_1.3.1.zip</code>
</li>
</ul>
<p>事实上，这是您在调用 <code>isntall.packages()</code> 时通常进行的部分幕后操作。</p>
<p>如果解压缩二进制包，您将看到它的内部结构与源码包或捆绑包有很大不同。 <a href="#fig-package-files">Figure&nbsp;<span>3.1</span></a> 包含了二者的比较。 以下是一些最显著的区别：</p>
<ul>
<li><p>在 <code>R/</code> 目录中没有 <code>.R</code> 文件，而是有三个文件以有效的文件格式存储着解析的函数。 这基本上是加载所有 R 代码，然后用 <code><a href="https://rdrr.io/r/base/save.html">save()</a></code> 保存函数的结果。 （在这个过程中，这会添加一些额外的 metadata，使得过程尽可能地快）。</p></li>
<li><p><code>Meta/</code> 目录中包含许多 <code>.rds</code> 文件。 这些文件包含有关包的缓存 metadata，如帮助文件所涵盖的主题和 <code>DESCRIPTION</code> 文件的解析版本。 （您可以使用 <code><a href="https://rdrr.io/r/base/readRDS.html">readRDS()</a></code> 查看这些文件中的内容）。 这些文件通过缓存代价高昂的计算使程序包更快地加载。</p></li>
<li><p>实际的帮助内容出现在 <code>help/</code> 和 <code>html/</code>（不再出现在 <code>man/</code>）中。</p></li>
<li><p>如果 <code>src/</code> 目录中有任何代码，那么现在将有一个 <code>libs/</code> 目录，其中包含经过编译的代码。</p></li>
<li><p>如果 <code>data/</code> 中有任何对象，则它们现在已转换为更具效率的形式。</p></li>
<li><p><code>inst/</code> 的内容被移动到顶层目录。 例如，vignette 文件现在位于 <code>doc/</code> 中。</p></li>
<li><p>一些文件和文件夹已被删除，如 <code>README.md</code>、<code>build/</code>、<code>tests/</code> 和 <code>vignettes/</code>。</p></li>
</ul></section><section id="sec-installed-package" class="level2" data-number="3.5"><h2 data-number="3.5" class="anchored" data-anchor-id="sec-installed-package">
<span class="header-section-number">3.5</span> Installed package</h2>
<p>已安装的（<strong>installed</strong>）包是已解压缩到程序包库中的二进制包（described in <a href="#sec-library"><span>Section&nbsp;3.7</span></a>）。 <a href="#fig-installation">Figure&nbsp;<span>3.2</span></a> 说明了安装程序包的多种方法，以及将软件包从一种状态转换为另一种状态的一些其他函数。 这个图表很复杂！在理想情况下，安装包需要将一组简单的步骤串在一起：source -&gt; bundle, bundle -&gt; binary, binary -&gt; installed。 在现实世界中，这个过程并不是这么简单，因为通常有（更快的）快捷方式可用。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-installation" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="diagrams/install-load.png" class="img-fluid figure-img" alt="A chart showing different ways to go from one package state to another: 1. library() puts an installed package into memory. 2. Functions such as install.packages(),    devtools::install_github(), and devtools::install()    can install a package starting variously in the source,    bundle, or binary forms. 3. devtools::build() can create a bundle or a binary. 4. devtools::load_all() puts a source package into memory." width="933"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;3.2: Many methods for converting between package states.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>内置命令行工具 <code>R CMD INSTALL</code> 支持所有程序包的安装。 它可以从源码文件、捆绑包、或二进制包安装程序包。 有关详细信息，请参阅 <a href="https://cran.r-project.org/doc/manuals/R-admin.html">R Installation and Administration</a> 的 <a href="https://cran.r-project.org/doc/manuals/R-admin.html#Installing-packages">Installing packages</a> 部分。 与 <code><a href="https://devtools.r-lib.org/reference/build.html">devtools::build()</a></code> 一样，devtools 提供了一个包装函数 <code><a href="https://devtools.r-lib.org/reference/install.html">devtools::install()</a></code>，使该工具在 R 会话（R Session）中可用。</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
RStudio
</div>
</div>
<div class="callout-body-container callout-body">
<p>RStudio 可以帮助您安装开发中的包，通过 <em>Build</em> 窗格中的 <em>Install</em> 和 <em>More</em> 下拉菜单以及 <em>Build</em> 菜单中的 <em>Install Package</em>。</p>
</div>
</div>
<p>可以理解，大多数用户喜欢 R 会话（R Session）的舒适性，因此直接从 CRAN 安装软件包。 内置函数 <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages()</a></code> 满足了这一需要。 它可以以各种形式下载程序包并安装它，还可以选择程序包依赖项的安装。</p>
<p>然而，从 R 会话中安装 R 包的便利性是有代价的。 如您所料，重新安装已在当前会话中使用的包可能有点棘手。 这实际上大部分时间都有效，但有时却无效，尤其是在 Windows 上安装带有编译代码的 R 包时。 由于文件句柄在 Windows 上的锁定方式，尝试安装正在使用的包的新版本可能会导致安装损坏，其中包的 R 代码已更新，但其编译代码尚未更新。 排除故障时，Windows 用户应努力在干净的 R 会话中安装包，并加载尽可能少的包。</p>
<p>pak 包 (<a href="https://pak.r-lib.org/" class="uri">https://pak.r-lib.org/</a>) 相对较新（在撰写本文时），它提供了一个有前途的替代 <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages()</a></code> 以及其他更专业的功能，例如 <code><a href="https://remotes.r-lib.org/reference/install_github.html">devtools::install_github()</a></code>。 现在全面推荐使用 pak 来满足您的所有软件包安装需求还为时过早，但我们肯定在我们的个人工作流程中越来越多地使用它。 pak 的旗舰功能之一是它很好地解决了上述 “locked DLL” 问题，即在 Windows 上使用编译代码更新包。 随着您对包开发的深入，您会发现自己正在执行一组全新的任务，例如从开发中的分支安装依赖项或仔细检查包依赖项树。 pak 为这个任务和许多其他相关任务提供了一个丰富的工具包。 我们预计 pak 将很快成为我们关于如何安装软件包（以及更多）的官方推荐。</p>
<p>然而，与此同时，我们描述了现状。 devtools 长期以来一直提供一系列 <code>install_*()</code> 函数来解决一些超出 <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages()</a></code> 范围的需求，或者使现有功能更容易访问。 这些功能实际上是在 <a href="https://remotes.r-lib.org/">remotes package</a> 中维护的，并由 devtools 重新导出。 （鉴于我们上面所说的，remotes 很可能会在本质上被取代，取而代之的是 pak，但我们还没有到那一步。）</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://remotes.r-lib.org">remotes</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">funs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/ls_str.html">lsf.str</a></span><span class="op">(</span><span class="st">"package:remotes"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"^install_.+"</span>, <span class="va">funs</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "install_bioc"      "install_bitbucket" "install_cran"     </span></span>
<span><span class="co">#&gt;  [4] "install_deps"      "install_dev"       "install_git"      </span></span>
<span><span class="co">#&gt;  [7] "install_github"    "install_gitlab"    "install_local"    </span></span>
<span><span class="co">#&gt; [10] "install_remote"    "install_svn"       "install_url"      </span></span>
<span><span class="co">#&gt; [13] "install_version"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code><a href="https://remotes.r-lib.org/reference/install_github.html">install_github()</a></code> 是这些函数中最有用的一个，也显示在 <a href="#fig-installation">Figure&nbsp;<span>3.2</span></a> 中。 它是一系列功能的最佳示例，可以从非 CRAN 的远程位置下载包，并执行安装包所需的任何操作。 其余的 devtools/remotes <code>install_*()</code> 函数旨在使基本工具在技术上更简单或更明确一些，例如 <code><a href="https://remotes.r-lib.org/reference/install_version.html">install_version()</a></code>，它能够安装特定版本的 CRAN 包。</p>
<p>与 <code>.Rbuildignore</code> 类似，如 <a href="#sec-rbuildignore"><span>Section&nbsp;3.3.1</span></a> 所述，<code>.Rinstignore</code> 允许您将捆绑包中的文件保留在已安装包之外。 然而，与 <code>.Rbuildignore</code> 相反，这个功能相当模糊，而且很少需要这样做。</p>
</section><section id="in-memory-package" class="level2" data-number="3.6"><h2 data-number="3.6" class="anchored" data-anchor-id="in-memory-package">
<span class="header-section-number">3.6</span> In-memory package</h2>
<p>我们终于讲述到了一个每个使用 R 的人都熟悉的命令。</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://usethis.r-lib.org">usethis</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>假设已经安装了 usethis，这个语句将使得里面的所有函数可用，即现在我们可以执行以下操作：</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://usethis.r-lib.org/reference/create_package.html">create_package</a></span><span class="op">(</span><span class="st">"/path/to/my/coolpackage"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>这样，usethis 包已加载到内存中，并且实际上也已附加到搜索路径。 在编写脚本时，加载和附加程序包之间的区别并不重要，但在编写程序包时非常重要。 您将在 <a href="dependencies-mindset-background.html#sec-dependencies-attach-vs-load"><span>Section&nbsp;10.4</span></a> 中了解更多关于差异及其重要性的信息。</p>
<p><code><a href="https://rdrr.io/r/base/library.html">library()</a></code> 并不是迭代调整和测试正在开发的程序包的好方法，因为它只适用于已安装的包。 在 <a href="workflow101.html#sec-workflow101-load-all"><span>Section&nbsp;4.4</span></a> 中，您将了解 <code><a href="https://devtools.r-lib.org/reference/load_all.html">devtools::load_all()</a></code> 如何通过允许您将源码包直接加载到内存中来加速开发过程。</p>
</section><section id="sec-library" class="level2" data-number="3.7"><h2 data-number="3.7" class="anchored" data-anchor-id="sec-library">
<span class="header-section-number">3.7</span> Package libraries</h2>
<p>我们刚刚讨论了 <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> 函数，它的名字源于它的作用。 当你调用 <code><a href="https://rdrr.io/r/base/library.html">library(somepackage)</a></code> 时，R 会在当前 <strong>libraries</strong> 中查找一个叫做 “somepackage” 的已安装包，如果成功了，R 将让 somepackage 变得可以使用。</p>
<p>在 R 中，一个 <strong>library</strong> 就是一个包含了已安装程序包的目录，有点像图书库。 不幸的是，在 R 的世界，您将会经常遇到 “library” 和 “package” 的混淆用法。 例如，dplyr 是一个 package，但是通常有人将其称为一个 library。 造成这种混乱的原因有几个。 首先，R 的术语可以说是与更广泛的编程约定背道而驰的，“library” 的通常含义更接近于我们所说的 “package”。 <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> 函数本身的名称可能会强化这一错误的关联。 最后，这种词汇错误通常是无害的，因此 R 用户很容易养成错误的习惯，而指出这个错误的人看起来像是令人无法忍受的学究。 但底线是：</p>
<blockquote class="blockquote">
<p>我们使用 <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> 函数加载一个 <strong>package</strong><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>。</p>
</blockquote>
<p>当您参与包开发时，两者之间的区别是重要且有用的。</p>
<p>您的计算机上可以有多个 libraries。 事实上，你们中的很多人已经这样做了，尤其是在 Windows 上。 可以使用 <code><a href="https://rdrr.io/r/base/libPaths.html">.libPaths()</a></code> 查看当前处于活动状态的 libraries。 在 Windows 上看起来如下：</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># on Windows</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/libPaths.html">.libPaths</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "C:/Users/jenny/Documents/R/win-library/4.2"</span></span>
<span><span class="co">#&gt; [2] "C:/Program Files/R/R-4.2.2/library"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/libPaths.html">.libPaths</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">list.dirs</span>, recursive <span class="op">=</span> <span class="cn">FALSE</span>, full.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;   [1] "abc"           "anytime"       "askpass"       "assertthat"   </span></span>
<span><span class="co">#&gt;  ...</span></span>
<span><span class="co">#&gt; [145] "zeallot"      </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt;  [1] "base"         "boot"         "class"        "cluster"     </span></span>
<span><span class="co">#&gt;  [5] "codetools"    "compiler"     "datasets"     "foreign"     </span></span>
<span><span class="co">#&gt;  [9] "graphics"     "grDevices"    "grid"         "KernSmooth"  </span></span>
<span><span class="co">#&gt; [13] "lattice"      "MASS"         "Matrix"       "methods"     </span></span>
<span><span class="co">#&gt; [17] "mgcv"         "nlme"         "nnet"         "parallel"    </span></span>
<span><span class="co">#&gt; [21] "rpart"        "spatial"      "splines"      "stats"       </span></span>
<span><span class="co">#&gt; [25] "stats4"       "survival"     "tcltk"        "tools"       </span></span>
<span><span class="co">#&gt; [29] "translations" "utils"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>在 macOS 上看起来类似（但您的结果可能会有所不同）:</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># on macOS</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/libPaths.html">.libPaths</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "/Users/jenny/Library/R/arm64/4.2/library"</span></span>
<span><span class="co">#&gt; [2] "/Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/libPaths.html">.libPaths</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">list.dirs</span>, recursive <span class="op">=</span> <span class="cn">FALSE</span>, full.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;    [1] "abc"                  "abc.data"             "abind"                </span></span>
<span><span class="co">#&gt;  ...</span></span>
<span><span class="co">#&gt; [1033] "Zelig"                "zip"                  "zoo"                 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt;  [1] "base"         "boot"         "class"        "cluster"     </span></span>
<span><span class="co">#&gt;  [5] "codetools"    "compiler"     "datasets"     "foreign"     </span></span>
<span><span class="co">#&gt;  [9] "graphics"     "grDevices"    "grid"         "KernSmooth"  </span></span>
<span><span class="co">#&gt; [13] "lattice"      "MASS"         "Matrix"       "methods"     </span></span>
<span><span class="co">#&gt; [17] "mgcv"         "nlme"         "nnet"         "parallel"    </span></span>
<span><span class="co">#&gt; [21] "rpart"        "spatial"      "splines"      "stats"       </span></span>
<span><span class="co">#&gt; [25] "stats4"       "survival"     "tcltk"        "tools"       </span></span>
<span><span class="co">#&gt; [29] "translations" "utils"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>在这两种情况下，我们可以看到两个活动库，它们的查询顺序如下：</p>
<ol type="1">
<li>用户库</li>
<li>系统级或全局库</li>
</ol>
<p>这样的设置是 Windows 上的经典设置，但通常是 macOS 和 Linux 上需要选择的设置<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>。 在这样的设置之下，从 CRAN（或其他地方）安装的或本地开发的附加程序包保存在用户库中。 和上面一样，macOS 系统被用作主要的开发机器，这里有很多软件包（~1000），而 Windows 系统只是偶尔使用，而且要简朴得多。 R 附带的基本和推荐程序包的核心集位于系统级库中，这一点在 macOS 和 Windows 上是相同的。 这种分离对许多开发人员很有吸引力，例如，在不干扰 base R 的安装的情况下使得清理附加包变得很容易。</p>
<p>如果您在 macOS 或 Linux 上只看到一个库，并不需要紧急更改任何内容。 但下次升级 R 时，请考虑创建一个用户级库。 默认情况下，R 查找存储在环境变量 <code>R_LIBS_USER</code> 中的路径下的用户库，在 macOS 上默认为 <code>~/Library/R/x.y/library</code>，在 Linux 上默认为 <code>~/R/m-library/x.y</code>（其中 <code>m</code> 是 CPU 架构的简明描述，<code>x.y</code> 是 R 版本）。 您可以使用 <code>Sys.getenv("R_LIBS_USER")</code> 查看此路径。 默认情况下这些目录不存在，必须通过创建目录来启用它们。 安装新版本的 R 时，在安装任何附加包之前，请使用 <code>dir.create(Sys.getenv("R_LIBS_USER"), recursive = TRUE)</code> 在默认位置创建用户库。 现在您将拥有上面看到的库设置。 或者，您可以在其他地方设置用户库，并通过在 <code>.Renviron</code> 中设置 <code>R_LIBS_USER</code> 环境变量来告诉 R。 编辑 <code>.Renviron</code> 文件的最简单方法是使用 <code><a href="https://usethis.r-lib.org/reference/edit.html">usethis::edit_r_environ()</a></code>，如果文件不存在，它将创建该文件，并打开它进行编辑。</p>
<p>这些库的文件路径也清楚地表明它们与特定版本的 R（在编写本文时是 4.2.x）相关联，这也是经典的。 这反映并强化了这样一个事实：当您将 R 从 4.1 更新到 4.2，即一个在次要（<strong>minor</strong>）版本上的更改时，您需要重新安装附加程序包。 对于在补丁（<strong>patch</strong>）版本上的更改，例如从 R 4.2.1 到 4.2.2，通常不需要重新安装附加程序包。</p>
<p>随着 R 的使用变得越来越复杂，开始更加有意地管理程序包库是十分平常的。 例如，像 <a href="https://rstudio.github.io/renv/">renv</a>（及其前身 <a href="https://rstudio.github.io/packrat/">packrat</a>）这样的工具可以使管理项目特定库的过程自动化。 这对于使数据产品具有可复制性、可移植性和相互隔离性非常重要。 程序包开发人员可能会在库的搜索路径前添加一个临时库，其中包含一组特定版本的程序包，以便在不影响其他日常工作的情况下探索前后兼容性问题。 反向依赖性检查（Reverse dependency checks）是另一个显式管理库的搜索路径的例子。</p>
<p>以下是按范围和持久性顺序控制哪些库处于活动状态的主要杠杆：</p>
<p>Here are the main levers that control which libraries are active, in order of scope and persistence:</p>
<ul>
<li>环境变量，如 <code>R_LIBS</code> 和 <code>R_LIBS_USER</code>，它们在启动时被查询。</li>
<li>使用一个或多个文件路径调用 <code><a href="https://rdrr.io/r/base/libPaths.html">.libPaths()</a></code>。</li>
<li>通过 <code><a href="https://withr.r-lib.org/reference/with_libpaths.html">withr::with_libpaths()</a></code> 使用临时更改的库搜索路径执行小型的代码段。</li>
<li>单个函数的参数，比如 <code>install.packages(lib =)</code> 和 <code><a href="https://rdrr.io/r/base/library.html">library(lib.loc =)</a></code>。</li>
</ul>
<p>最后，需要注意的是，<code><a href="https://rdrr.io/r/base/library.html">library()</a></code> 永远不应该在程序包中使用。 程序包和脚本依赖于不同的机制来声明它们的依赖性，这是您需要在您的心理模型和习惯中做出的最大调整之一。 我们将在 <a href="description.html#sec-description-imports-suggests"><span>Section&nbsp;9.6</span></a> 和 <a href="dependencies-in-practice.html"><span>Chapter&nbsp;11</span></a> 全面探讨这个话题。</p>


</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>要查看应该在您的雷达上的文件路径集，请在包的顶级目录中执行 <code>dir(full.names = TRUE, recursive = TRUE, include.dirs = TRUE, all.files = TRUE)</code> 。<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>嗯，实际上，<code><a href="https://rdrr.io/r/base/library.html">library()</a></code> 加载并附加一个 package，但这是 <a href="dependencies-mindset-background.html#sec-dependencies-attach-vs-load"><span>Section&nbsp;10.4</span></a> 的主题。<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>有关更多详细信息，请参阅 <em>What They Forgot To Teach You About R</em> 中的 <a href="https://whattheyforgot.org/maintaining-r.html#how-to-transfer-your-library-when-updating-r">Maintaining R section</a> 部分、<em>R Installation and Administration</em> 中的 <a href="https://rstudio.github.io/r-manuals/r-admin/Add-on-packages.html#managing-libraries">Managing Libraries</a> 以及 <code><a href="https://rdrr.io/r/base/Startup.html">?Startup</a></code> 和 <code><a href="https://rdrr.io/r/base/libPaths.html">?.libPaths</a></code> 的 R 帮助文件。<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./setup.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">System setup</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./workflow101.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Fundamental development workflows</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>