<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="description" content="Learn how to create a package, the fundamental unit of shareable, reusable, and reproducible R code.">
<title>R Packages (2e) - 6&nbsp; R code</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./data.html" rel="next">
<link href="./package-within.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script defer="" data-domain="r-pkgs.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">R code</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R Packages (2e)</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/zhenghu159/r-pkgs-zh-cn" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle sidebar-tool" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Welcome!</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./introduction.html" class="sidebar-item-text sidebar-link">Introduction</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Getting started</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./whole-game.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">The Whole Game</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./setup.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">System setup</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./structure.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Package structure and state</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./workflow101.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Fundamental development workflows</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./package-within.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">The package within</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Package components</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./code.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">R code</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./misc.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Other components</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">Package metadata</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./description.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title"><code>DESCRIPTION</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dependencies-mindset-background.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Dependencies: Mindset and Background</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dependencies-in-practice.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Dependencies: In Practice</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./license.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Licensing</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">Testing</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./testing-basics.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Testing basics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./testing-design.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Designing your test suite</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./testing-advanced.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Advanced testing techniques</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">Documentation</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./man.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Function documentation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./vignettes.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Vignettes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./other-markdown.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Other markdown files</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./website.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Website</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">Maintenance and distribution</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./software-development-practices.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Software development practices</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lifecycle.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Lifecycle</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./release.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Releasing to CRAN</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">Appendices</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./R-CMD-check.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title"><code>R CMD check</code></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#sec-code-organising" id="toc-sec-code-organising" class="nav-link active" data-scroll-target="#sec-code-organising"><span class="toc-section-number">6.1</span>  Organise functions into files</a></li>
  <li><a href="#sec-code-load-all" id="toc-sec-code-load-all" class="nav-link" data-scroll-target="#sec-code-load-all"><span class="toc-section-number">6.2</span>  Fast feedback via <code>load_all()</code></a></li>
  <li><a href="#code-style" id="toc-code-style" class="nav-link" data-scroll-target="#code-style"><span class="toc-section-number">6.3</span>  Code style</a></li>
  <li>
<a href="#sec-code-when-executed" id="toc-sec-code-when-executed" class="nav-link" data-scroll-target="#sec-code-when-executed"><span class="toc-section-number">6.4</span>  Understand when code is executed</a>
  <ul class="collapse">
<li><a href="#example-a-path-returned-by-system.file" id="toc-example-a-path-returned-by-system.file" class="nav-link" data-scroll-target="#example-a-path-returned-by-system.file"><span class="toc-section-number">6.4.1</span>  Example: A path returned by <code>system.file()</code></a></li>
  <li><a href="#example-available-colours" id="toc-example-available-colours" class="nav-link" data-scroll-target="#example-available-colours"><span class="toc-section-number">6.4.2</span>  Example: Available colours</a></li>
  <li><a href="#example-aliasing-a-function" id="toc-example-aliasing-a-function" class="nav-link" data-scroll-target="#example-aliasing-a-function"><span class="toc-section-number">6.4.3</span>  Example: Aliasing a function</a></li>
  </ul>
</li>
  <li>
<a href="#sec-code-r-landscape" id="toc-sec-code-r-landscape" class="nav-link" data-scroll-target="#sec-code-r-landscape"><span class="toc-section-number">6.5</span>  Respect the R landscape</a>
  <ul class="collapse">
<li><a href="#manage-state-with-withr" id="toc-manage-state-with-withr" class="nav-link" data-scroll-target="#manage-state-with-withr"><span class="toc-section-number">6.5.1</span>  Manage state with withr</a></li>
  <li><a href="#restore-state-with-baseon.exit" id="toc-restore-state-with-baseon.exit" class="nav-link" data-scroll-target="#restore-state-with-baseon.exit"><span class="toc-section-number">6.5.2</span>  Restore state with <code>base::on.exit()</code></a></li>
  <li><a href="#isolate-side-effects" id="toc-isolate-side-effects" class="nav-link" data-scroll-target="#isolate-side-effects"><span class="toc-section-number">6.5.3</span>  Isolate side effects</a></li>
  <li><a href="#sec-code-onLoad-onAttach" id="toc-sec-code-onLoad-onAttach" class="nav-link" data-scroll-target="#sec-code-onLoad-onAttach"><span class="toc-section-number">6.5.4</span>  When you <strong>do</strong> need side-effects</a></li>
  </ul>
</li>
  <li><a href="#constant-health-checks" id="toc-constant-health-checks" class="nav-link" data-scroll-target="#constant-health-checks"><span class="toc-section-number">6.6</span>  Constant health checks</a></li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/zhenghu159/r-pkgs-zh-cn/edit/main/code.Rmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/zhenghu159/r-pkgs-zh-cn/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-r" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">R code</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><div class="cell">

</div>
<p>制作包的首要原则是所有 R 代码都放在 <code>R/</code> 目录中。 在本章中，您将学习如何将函数组织到文件中，保持一致的风格，并认识到包中函数的更严格要求（与脚本中的函数相比）。 我们还将提醒您测试驱动和正式检查开发中包的基本工作流程：<code>load_all()</code>、<code>test()</code> 和 <code>check()</code>。</p>
<section id="sec-code-organising" class="level2" data-number="6.1"><h2 data-number="6.1" class="anchored" data-anchor-id="sec-code-organising">
<span class="header-section-number">6.1</span> Organise functions into files</h2>
<p>唯一的硬性规定是您的包必须将其函数定义存储在 R 脚本中，即扩展名为 <code>.R</code> 的文件，它们位于 <code>R/</code> 目录中<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>。 然而，更多的约定可以使您的包的源代码更易于浏览，并使您不必重新回答“我应该如何命名它？”，在每次创建新文件时。 Tidyverse Style Guide 提供了一些 <a href="https://style.tidyverse.org/files.html">general advice about file names</a>，以及 <a href="https://style.tidyverse.org/package-files.html">advice that specifically applies to files in a package</a>。 我们在这里展开。</p>
<p>文件名应该有意义并传达其中定义了哪些功能。 虽然您可以随意将函数安排到文件中，但有两个极端是不好的：不要将所有函数放入一个文件中，也不要将每个函数放入其自己的单独文件中。 该建议应告知您的一般政策，但每条规则都有例外。 如果一个特定的函数非常大或有很多文档，给它一个自己的文件，以函数命名是有意义的。 更常见的是，单个 <code>.R</code> 文件将包含多个函数定义：例如一个主函数及其辅助函数、一系列相关函数或两者的某种组合。</p>
<p><a href="#tbl-putting-functions-in-files">Table&nbsp;<span>6.1</span></a> 展示了 <a href="http://tidyr.tidyverse.org/">tidyr package</a> 1.1.2 版的实际来源中的一些示例。 与上面给出的硬性规定有一些偏差，这说明这里有很大的判断空间。</p>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-putting-functions-in-files" class="anchored">
<table class="table table-sm table-striped">
<caption>Table&nbsp;6.1: Different ways to organize functions in files.</caption>
<thead><tr class="header">
<th style="text-align: left;">Organising principle</th>
<th style="text-align: left;">Source file</th>
<th style="text-align: left;">Comments</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">One function</td>
<td style="text-align: left;"><a href="https://github.com/tidyverse/tidyr/blob/v1.1.2/R/uncount.R">tidyr/R/uncount.R</a></td>
<td style="text-align: left;">Defines exactly one function, <code>uncount()</code>, that’s not particulary large, but doesn’t fit naturally into any other <code>.R</code> file</td>
</tr>
<tr class="even">
<td style="text-align: left;">Main function plus helpers</td>
<td style="text-align: left;"><a href="https://github.com/tidyverse/tidyr/blob/v1.1.2/R/separate.R">tidyr/R/separate.R</a></td>
<td style="text-align: left;">Defines the user-facing <code>separate()</code> (an S3 generic), a <code>data.frame</code> method, and private helpers</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Family of functions</td>
<td style="text-align: left;"><a href="https://github.com/tidyverse/tidyr/blob/v1.1.2/R/rectangle.R">tidyr/R/rectangle.R</a></td>
<td style="text-align: left;">Defines a family of functions for “rectangling” nested lists (<code>hoist()</code> and the <code>unnest()</code> functions), all documented together in a big help topic, plus private helpers</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>您经常看到的另一个文件是 <code>R/utils.R</code>。 这是定义在多个包函数中使用的小型实用程序的常见位置。 由于它们充当多个函数的 helpers，将它们放在 <code>R/utils.R</code> 中可以让您在经过长时间后返回包时更容易重新发现它们。</p>
<p>Bob Rudis 汇集了此类文件，并在后文 <a href="https://rud.is/b/2018/04/08/dissecting-r-package-utility-belts/">Dissecting R Package “Utility Belts”</a> 中进行了一些分析。</p>
</div>
</div>
<p>如果很难预测函数位于哪个文件中，则表明是时候将函数分成更多文件或重新考虑如何命名函数和/或文件了。</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
RStudio
</div>
</div>
<div class="callout-body-container callout-body">
<p>文件中函数的组织在 RStudio 中不太重要，它提供了两种跳转到函数定义的方法：</p>
<ul>
<li>
<p>按 Ctrl + <code>.</code>（句号）调出 <em>Go to File/Function</em> 工具，如 <a href="#fig-go-to-file-function">Figure&nbsp;<span>6.1</span></a> 所示，然后开始输入名称。 继续键入以缩小列表并最终选择要访问的函数（或文件）。 这适用于项目中的函数和文件。</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-go-to-file-function" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="images/file-finder.png" class="img-fluid figure-img" alt="Screenshot of the &quot;Go to File/Function&quot; tool in the RStudio IDE. It is a text box with the cursor in it." width="249"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;6.1: Go to File/Function in RStudio.</figcaption><p></p>
</figure>
</div>
</div>
</div>
</li>
<li><p>将光标放在函数名称上或选中函数名称后，按 F2。 这适用于在您的包或另一个包中定义的函数。</p></li>
</ul>
<p>使用其中一种方法导航到函数后，通过单击编辑器左上角的后退箭头 (<img src="images/arrows.png" width="33" height="16">) 或按 Ctrl + F9（Windows 和 Linux）或 Cmd + F9（macOS）返回到开始的位置。</p>
</div>
</div>
</section><section id="sec-code-load-all" class="level2" data-number="6.2"><h2 data-number="6.2" class="anchored" data-anchor-id="sec-code-load-all">
<span class="header-section-number">6.2</span> Fast feedback via <code>load_all()</code>
</h2>
<p>当您添加或修改在 <code>R/</code> 下的文件中定义的函数时，您自然会想要尝试它们。 我们想重申我们强烈建议使用 <code><a href="https://devtools.r-lib.org/reference/load_all.html">devtools::load_all()</a></code> 来使它们可用于交互式探索，而不是使用例如 <code>R/</code> 下的 <code><a href="https://rdrr.io/r/base/source.html">source()</a></code>ing 文件。 <code>load_all()</code> 的主要内容在 <a href="workflow101.html#sec-workflow101-load-all"><span>Section&nbsp;4.4</span></a> 中，<code>load_all()</code> 也作为自然开发任务之一出现在 <a href="whole-game.html#sec-whole-game-load-all"><span>Section&nbsp;1.8</span></a> 中。 <code>load_all()</code> 在 testthat 工作流中的重要性在 <a href="testing-design.html#sec-testing-design-tension"><span>Section&nbsp;14.2.5</span></a> 中进行了解释。 与备选方案相比，<code>load_all()</code> 可帮助您更快地进行迭代，并提供对已安装包的命名空间机制的出色近似。</p>
</section><section id="code-style" class="level2" data-number="6.3"><h2 data-number="6.3" class="anchored" data-anchor-id="code-style">
<span class="header-section-number">6.3</span> Code style</h2>
<p>我们建议遵循 tidyverse 风格指南 (<a href="https://style.tidyverse.org" class="uri">https://style.tidyverse.org</a>)，它比我们在这里介绍的更详细。 它的格式也使其成为比本书更具活力的文档。</p>
<p>尽管风格指南解释了“什么”和“为什么”，另一个重要的决定是如何实施特定的代码风格。 为此，我们推荐 styler 包 (<a href="https://styler.r-lib.org" class="uri">https://styler.r-lib.org</a>)；它的默认行为强制执行 tidyverse 风格指南。 有多种方法可以将 styler 应用于您的代码，具体取决于上下文：</p>
<ul>
<li>
<code>styler::style_pkg()</code> 重新设置整个 R 包的样式。</li>
<li>
<code>styler::style_dir()</code> 重新设置目录中所有文件的样式。</li>
<li>
<code><a href="https://usethis.r-lib.org/reference/tidyverse.html">usethis::use_tidy_style()</a></code> 是根据当前项目是否为 R 包应用上述功能之一的包装器。</li>
<li>
<code>styler::style_file()</code> 重新设置单个文件的样式。</li>
<li>
<code>styler::style_file()</code> 重新设置字符向量的样式。</li>
</ul>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
RStudio
</div>
</div>
<div class="callout-body-container callout-body">
<p>安装 styler 后，RStudio Addins 菜单将提供几种额外的样式代码方式：</p>
<ul>
<li>the active selection</li>
<li>the active file</li>
<li>the active package</li>
</ul>
</div>
</div>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>如果您不使用 Git 或其他版本控制系统，那么应用像 <code>styler::style_pkg()</code> 这样的函数会很伤脑筋，而且有些危险，因为您无法准确查看更改内容并接受/拒绝此类更改颗粒状的方式。</p>
</div>
</div>
<p>styler 包还可以与各种平台集成，用于托管源代码和进行持续集成。 例如，tidyverse 包使用 GitHub 操作，当拉取请求中的特殊评论 (<code>/style</code>) 触发时，该操作会重新设置包的样式。 这允许维护者专注于审查拉取请求的实质内容，而不必挑剔空白或缩进的小问题<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a><a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>。</p>
</section><section id="sec-code-when-executed" class="level2" data-number="6.4"><h2 data-number="6.4" class="anchored" data-anchor-id="sec-code-when-executed">
<span class="header-section-number">6.4</span> Understand when code is executed</h2>
<p>到目前为止，您可能一直在编写脚本，R 代码保存在您交互式执行的文件中，可能使用 IDE 和/或 <code><a href="https://rdrr.io/r/base/source.html">source()</a></code>，或者通过 <code>Rscript</code> 非交互式执行。 脚本和包中的代码之间有两个主要区别：</p>
<ul>
<li><p>在脚本中，代码运行 … 当你运行它的时候！ 这种说法的尴尬反映了用剧本来思考这个问题是很困难的。 但是，我们必须了解包中的代码是在构建包时运行的。 这对你如何编写 <code>R/</code> 下的代码有很大的影响：包代码应该只创建对象，其中绝大多数是函数。</p></li>
<li><p>你的包中的函数将在你没有想象到的情况下使用。 这意味着您的函数在与外界交互的方式上需要深思熟虑。</p></li>
</ul>
<p>我们在这里扩展第一点，在下一节中扩展第二点。 这些主题也在 <a href="package-within.html#sec-package-within-build-time-run-time"><span>Section&nbsp;5.6</span></a> 中具体说明。</p>
<p>当你 <code><a href="https://rdrr.io/r/base/source.html">source()</a></code> 一个脚本时，每一行代码都会被执行，结果会立即可用。 包代码的情况不同，因为它是分两步加载的。 当构建二进制包时（通常由 CRAN），<code>R/</code> 中的所有代码都会被执行并保存结果。 当您使用 <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> 附加一个包时，这些缓存的结果将被重新加载，并且某些对象（主要是函数）可供您使用。 <a href="structure.html#sec-structure-binary"><span>Section&nbsp;3.4</span></a> 中给出了二进制形式的包的含义的完整详细信息。 我们将二进制包的创建称为（binary）“构建时间”，具体来说，我们指的是 <code>R CMD INSTALL --build</code> 运行时。 （您可能认为这就是 <code>R CMD build</code> 所做的，但实际上它生成了一个捆绑包，也就是”source tarball”。）对于 CRAN 包的 macOS 和 Windows 用户，构建时间是 CRAN 为其操作系统构建二进制包时。 对于那些从源代码安装包的人来说，构建时间本质上是他们（构建和）安装包的时间。</p>
<p>考虑赋值 <code>x &lt;- Sys.time()</code>。 如果你把它放在脚本中，<code>x</code> 会告诉你脚本何时是 <code><a href="https://rdrr.io/r/base/source.html">source()</a></code>d。 但是，如果您将相同的代码放在包的顶层，<code>x</code> 会告诉您包二进制文件的构建时间。 在 <a href="package-within.html#sec-package-within-build-time-run-time"><span>Section&nbsp;5.6</span></a> 中，我们展示了在包内形成时间戳的上下文中的完整示例。</p>
<p>主要内容是：</p>
<blockquote class="blockquote">
<p>函数之外的任何 R 代码都是可疑的，应该仔细检查。</p>
</blockquote>
<p>我们在下面探索了一些真实世界的例子，这些例子展示了这个“构建时间与加载时间”问题是多么容易被烧毁。 幸运的是，一旦您诊断出此问题，通常不难解决。</p>
<section id="example-a-path-returned-by-system.file" class="level3" data-number="6.4.1"><h3 data-number="6.4.1" class="anchored" data-anchor-id="example-a-path-returned-by-system.file">
<span class="header-section-number">6.4.1</span> Example: A path returned by <code>system.file()</code>
</h3>
<p>The shinybootstrap2 package once had this code below <code>R/</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dataTableDependency</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="fu">htmlDependency</span><span class="op">(</span></span>
<span>    <span class="st">"datatables"</span>, <span class="st">"1.10.2"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"www/datatables"</span>, package <span class="op">=</span> <span class="st">"shinybootstrap2"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    script <span class="op">=</span> <span class="st">"js/jquery.dataTables.min.js"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu">htmlDependency</span><span class="op">(</span></span>
<span>    <span class="st">"datatables-bootstrap"</span>, <span class="st">"1.10.2"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"www/datatables"</span>, package <span class="op">=</span> <span class="st">"shinybootstrap2"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    stylesheet <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"css/dataTables.bootstrap.css"</span>, <span class="st">"css/dataTables.extra.css"</span><span class="op">)</span>,</span>
<span>    script <span class="op">=</span> <span class="st">"js/dataTables.bootstrap.js"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So <code>dataTableDependency</code> was a list object defined in top-level package code and its value was constructed from paths obtained via <code><a href="https://rdrr.io/r/base/system.file.html">system.file()</a></code>. As described in <a href="https://github.com/rstudio/htmltools/issues/22">a GitHub issue</a>,</p>
<blockquote class="blockquote">
<p>This works fine when the package is built and tested on the same machine. However, if the package is built on one machine and then used on another (as is the case with CRAN binary packages), then this will fail – the dependency will point to the wrong directory on the host.</p>
</blockquote>
<p>The heart of the solution is to make sure that <code><a href="https://rdrr.io/r/base/system.file.html">system.file()</a></code> is called from a function, at run time. Indeed, this fix was made here (in commit <a href="https://github.com/rstudio/shinybootstrap2/commit/138db47e6bef195f14f6a14f4289ca445e9b2efa#diff-fedcc5cc99f3d44a4caf06f8e6e0ae08">138db47</a>) and in a few other packages that had similar code and a related check was added in <code>htmlDependency()</code> itself. This particular problem would now be caught by <code>R CMD check</code>, due to changes that came with <a href="https://developer.r-project.org/Blog/public/2019/02/14/staged-install/index.html">staged installation</a> as of R 3.6.0.</p>
</section><section id="example-available-colours" class="level3" data-number="6.4.2"><h3 data-number="6.4.2" class="anchored" data-anchor-id="example-available-colours">
<span class="header-section-number">6.4.2</span> Example: Available colours</h3>
<p>The crayon package has a function, <code><a href="https://rdrr.io/pkg/crayon/man/show_ansi_colors.html">crayon::show_ansi_colors()</a></code>, that displays an ANSI colour table on your screen, basically to show what sort of styling is possible. In an early version, the function looked something like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>show_ansi_colors <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">colors =</span> <span class="fu">num_colors</span>()) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (colors <span class="sc">&lt;</span> <span class="dv">8</span>) {</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Colors are not supported"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (colors <span class="sc">&lt;</span> <span class="dv">256</span>) {</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(ansi_colors_8, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">invisible</span>(ansi_colors_8)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(ansi_colors_256, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">invisible</span>(ansi_colors_256)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>ansi_colors_8 <span class="ot">&lt;-</span> <span class="co"># code to generate a vector covering basic terminal colors</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>ansi_colors_256 <span class="ot">&lt;-</span> <span class="co"># code to generate a vector covering 256 colors</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where <code>ansi_colors_8</code> and <code>ansi_colors_256</code> were character vectors exploring a certain set of colours, presumably styled via ANSI escapes.</p>
<p>The problem was those objects were formed and cached when the binary package was built. Since that often happens on a headless server, this likely happens under conditions where terminal colours might not be enabled or even available. Users of the installed package could still call <code>show_ansi_colors()</code> and <code>num_colors()</code> would detect the number of colours supported by their system (256 on most modern computers). But then an un-coloured object would print to screen (the original GitHub issue is <a href="https://github.com/r-lib/crayon/issues/37">r-lib/crayon#37</a>).</p>
<p>The solution was to compute the display objects with a function at run time (in commit <a href="https://github.com/r-lib/crayon/commit/e2b368ac27331d82154f85299f18efbc36227caa">e2b368a</a>:</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">show_ansi_colors</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">colors</span> <span class="op">=</span> <span class="fu">num_colors</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">colors</span> <span class="op">&lt;</span> <span class="fl">8</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Colors are not supported"</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">colors</span> <span class="op">&lt;</span> <span class="fl">256</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu">ansi_colors_8</span><span class="op">(</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="fu">ansi_colors_8</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu">ansi_colors_256</span><span class="op">(</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="fu">ansi_colors_256</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">ansi_colors_8</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># code to generate a vector covering basic terminal colors</span></span>
<span><span class="op">}</span></span>
<span>  </span>
<span><span class="va">ansi_colors_256</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># code to generate a vector covering 256 colors</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Literally, the same code is used, it is simply pushed down into the body of a function taking no arguments (similar to the shinybootstrap2 example). Each reference to, e.g., the <code>ansi_colors_8</code> object is replaced by a call to the <code>ansi_colors_8()</code> function.</p>
<p>The main takeaway is that functions that assess or expose the capabilities of your package on a user’s system must fully execute on your user’s system. It’s fairly easy to accidentally rely on results that were cached at build time, quite possibly on a different machine.</p>
</section><section id="example-aliasing-a-function" class="level3" data-number="6.4.3"><h3 data-number="6.4.3" class="anchored" data-anchor-id="example-aliasing-a-function">
<span class="header-section-number">6.4.3</span> Example: Aliasing a function</h3>
<p>One last example shows that, even if you are careful to only define functions below <code>R/</code>, there are still some subtleties to consider. Imagine that you want the function <code>foo()</code> in your package to basically be an alias for the function <code>blah()</code> from some other package, e.g.&nbsp;pkgB. You might be tempted to do this:</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">foo</span> <span class="op">&lt;-</span> <span class="fu">pkgB</span><span class="fu">::</span><span class="va">blah</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, this will cause <code>foo()</code> in your package to reflect the definition of <code>pkgB::blah()</code> at the version present on the machine where the binary package is built (often CRAN), at that moment in time. If a bug is discovered in <code>pkgB::blah()</code> and subsequently fixed, your package will still use the older, buggy version, until your package is rebuilt (often by CRAN) and your users upgrade, which is completely out of your control. This alternative approach protects you from this:</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">foo</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="fu">pkgB</span><span class="fu">::</span><span class="fu">blah</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, when your user calls <code>foo()</code>, they are effectively calling <code>pkgB::blah()</code>, at the version installed on <em>their</em> machine at that very moment.</p>
<p>A real example of this affected an older version of knitr, related to how the default “evaluate” hook was being set to <code><a href="https://rdrr.io/pkg/evaluate/man/evaluate.html">evaluate::evaluate()</a></code> (original issue is <a href="https://github.com/yihui/knitr/issues/1441">yihui/knitr#1441</a>, resolved in commit <a href="https://github.com/yihui/knitr/commit/d6b53e0f15a8afd1de4987a86931ba54f886278d">d6b53e0</a>).</p>
</section></section><section id="sec-code-r-landscape" class="level2" data-number="6.5"><h2 data-number="6.5" class="anchored" data-anchor-id="sec-code-r-landscape">
<span class="header-section-number">6.5</span> Respect the R landscape</h2>
<p>Another big difference between a script and a package is that other people are going to use your package, and they’re going to use it in situations that you never imagined. This means you need to pay attention to the R landscape, which includes not just the available functions and objects, but all the global settings.</p>
<p>You have changed the R landscape if you’ve loaded a package with <code><a href="https://rdrr.io/r/base/library.html">library()</a></code>, or changed a global option with <code><a href="https://rdrr.io/r/base/options.html">options()</a></code>, or modified the working directory with <code><a href="https://rdrr.io/r/base/getwd.html">setwd()</a></code>. If the behaviour of <em>other</em> functions differs before and after running your function, you’ve modified the landscape. <a href="package-within.html#sec-package-within-side-effects"><span>Section&nbsp;5.7</span></a> has a concrete example of this involving time zones and the locale-specific printing of datetimes. Changing the landscape is bad because it makes code much harder to understand.</p>
<p>There are some functions that modify global settings that you should never use because there are better alternatives:</p>
<ul>
<li><p><strong>Don’t use <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> or <code><a href="https://rdrr.io/r/base/library.html">require()</a></code></strong>. These modify the search path, affecting what functions are available from the global environment. Instead, you should use the <code>DESCRIPTION</code> to specify your package’s requirements, as described in <a href="description.html"><span>Chapter&nbsp;9</span></a>. This also makes sure those packages are installed when your package is installed.</p></li>
<li><p><strong>Never use <code><a href="https://rdrr.io/r/base/source.html">source()</a></code></strong> to load code from a file. <code><a href="https://rdrr.io/r/base/source.html">source()</a></code> modifies the current environment, inserting the results of executing the code. There is no reason to use <code><a href="https://rdrr.io/r/base/source.html">source()</a></code> inside your package, i.e.&nbsp;in a file below <code>R/</code>. Sometimes people <code><a href="https://rdrr.io/r/base/source.html">source()</a></code> files below <code>R/</code> during package development, but as we’ve explained in <a href="workflow101.html#sec-workflow101-load-all"><span>Section&nbsp;4.4</span></a> and <a href="#sec-code-load-all"><span>Section&nbsp;6.2</span></a>, <code>load_all()</code> is a much better way to load your current code for exploration. If you’re using <code><a href="https://rdrr.io/r/base/source.html">source()</a></code> to create a dataset, it is better to use the methods in <a href="data.html"><span>Chapter&nbsp;7</span></a> for including data in a package.</p></li>
</ul>
<p>Here is a non-exhaustive list of other functions that should be used with caution:</p>
<ul>
<li><code><a href="https://rdrr.io/r/base/options.html">options()</a></code></li>
<li><code><a href="https://rdrr.io/r/graphics/par.html">par()</a></code></li>
<li><code><a href="https://rdrr.io/r/base/getwd.html">setwd()</a></code></li>
<li><code><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv()</a></code></li>
<li><code><a href="https://rdrr.io/r/base/locales.html">Sys.setlocale()</a></code></li>
<li>
<code><a href="https://rdrr.io/r/base/Random.html">set.seed()</a></code> (or anything that changes the state of the random number generator)</li>
</ul>
<!-- TODO: maybe tell one or more of the scary stories in <https://github.com/hadley/r-pkgs/issues/447> --><p>If you must use them, make sure to clean up after yourself. Below we show how to do this using functions from the withr package and in base R.</p>
<p>The flip side of this coin is that you should avoid relying on the user’s landscape, which might be different to yours. For example, functions that rely on sorting strings are dangerous, because sort order depends on the system locale. Below we see that locales one might actually encounter in practice (C, English, French, etc.) differ in how they sort non-ASCII strings or uppercase versus lowercase letters.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bernard"</span>, <span class="st">"bérénice"</span>, <span class="st">"béatrice"</span>, <span class="st">"boris"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_locale.html">with_locale</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>LC_COLLATE <span class="op">=</span> <span class="st">"fr_FR"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "béatrice" "bérénice" "bernard"  "boris"</span></span>
<span><span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_locale.html">with_locale</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>LC_COLLATE <span class="op">=</span> <span class="st">"C"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "bernard"  "boris"    "béatrice" "bérénice"</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"b"</span>, <span class="st">"A"</span>, <span class="st">"b"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_locale.html">with_locale</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>LC_COLLATE <span class="op">=</span> <span class="st">"en_CA"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "a" "A" "A" "b" "b" "B"</span></span>
<span><span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_locale.html">with_locale</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>LC_COLLATE <span class="op">=</span> <span class="st">"C"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "A" "A" "B" "a" "b" "b"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you write your functions as if all users have the same system locale as you, your code might fail.</p>
<section id="manage-state-with-withr" class="level3" data-number="6.5.1"><h3 data-number="6.5.1" class="anchored" data-anchor-id="manage-state-with-withr">
<span class="header-section-number">6.5.1</span> Manage state with withr</h3>
<p>If you need to modify the R landscape inside a function, then it is important to ensure your change is reversed <em>on exit</em> of that function. This is exactly what <code><a href="https://rdrr.io/r/base/on.exit.html">base::on.exit()</a></code> is designed to do. You use <code><a href="https://rdrr.io/r/base/on.exit.html">on.exit()</a></code> inside a function to register code to run later, that restores the landscape to its original state. It is important to note that proper tools, such as <code><a href="https://rdrr.io/r/base/on.exit.html">on.exit()</a></code>, work even if we exit the function abnormally, i.e.&nbsp;due to an error. This is why it’s worth using the official methods described here over any do-it-yourself solution.</p>
<p>We usually manage state using the <a href="https://withr.r-lib.org">withr package</a>, which provides a flexible, <code><a href="https://rdrr.io/r/base/on.exit.html">on.exit()</a></code>-like toolkit (<code><a href="https://rdrr.io/r/base/on.exit.html">on.exit()</a></code> itself is covered in the next section). <code><a href="https://withr.r-lib.org/reference/defer.html">withr::defer()</a></code> can be used as a drop-in replacement for <code><a href="https://rdrr.io/r/base/on.exit.html">on.exit()</a></code>. Why do we like withr so much? First, it offers many pre-built convenience functions for state changes that come up often. We also appreciate withr’s default stack-like behaviour (LIFO = last in, first out), its usability in interactive sessions, and its <code>envir</code> argument (in more advanced usage).</p>
<p>The general pattern is to capture the original state, schedule its eventual restoration “on exit”, then make the state change. Some setters, such as <code><a href="https://rdrr.io/r/base/options.html">options()</a></code> or <code><a href="https://rdrr.io/r/graphics/par.html">par()</a></code>, return the old value when you provide a new value, leading to usage that looks like this:</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">z</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">...</span>                        <span class="co"># width option "as found"</span></span>
<span>  <span class="va">old</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="co"># width option is 20</span></span>
<span>  <span class="fu">defer</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span><span class="va">old</span><span class="op">)</span><span class="op">)</span>        <span class="co"># width option is 20</span></span>
<span>  <span class="va">...</span>                        <span class="co"># width option is 20</span></span>
<span><span class="op">}</span>                            <span class="co"># original width option restored</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Certain state changes, such as modifying session options, come up so often that withr offers pre-made helpers. <a href="#tbl-withr-greatest-hits">Table&nbsp;<span>6.2</span></a> shows a few of the state change helpers in withr that you are most likely to find useful:</p>
<div id="tbl-withr-greatest-hits" class="anchored">
<table class="table">
<caption>Table&nbsp;6.2: Selected functions from withr.</caption>
<thead><tr class="header">
<th>Do / undo this</th>
<th>withr functions</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Set an R option</td>
<td>
<code>with_options()</code>, <code>local_options()</code>
</td>
</tr>
<tr class="even">
<td>Set an environment variable</td>
<td>
<code>with_envvar()</code>, <code>local_envvar()</code>
</td>
</tr>
<tr class="odd">
<td>Change working directory</td>
<td>
<code>with_dir()</code>, <code>local_dir()</code>
</td>
</tr>
<tr class="even">
<td>Set a graphics parameter</td>
<td>
<code>with_par()</code>, <code>local_par()</code>
</td>
</tr>
</tbody>
</table>
</div>
<p>You’ll notice each helper comes in two forms that are useful in different situations:</p>
<ul>
<li>
<p><code>with_*()</code> functions are best for executing small snippets of code with a temporarily modified state. (These functions are inspired by how <code><a href="https://rdrr.io/r/base/with.html">base::with()</a></code> works.)</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">sig_digits</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># imagine lots of code here</span></span>
<span>  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_options.html">with_options</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co"># ... and a lot more code here</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p><code>local_*()</code> functions are best for modifying state “from now until the function exits”.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">g</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">sig_digits</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_options.html">local_options</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="co"># imagine lots of code here</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
</ul>
<p>Developing code interactively with withr is pleasant, because deferred actions can be scheduled even on the global environment. Those cleanup actions can then be executed with <code><a href="https://withr.r-lib.org/reference/defer.html">withr::deferred_run()</a></code> or cleared without execution with <code><a href="https://withr.r-lib.org/reference/defer.html">withr::deferred_clear()</a></code>. Without this feature, it can be tricky to experiment with code that needs cleanup “on exit”, because it behaves so differently when executed in the console versus at arm’s length inside a function.</p>
<p>More in-depth coverage is given in the withr vignette <a href="https://withr.r-lib.org/articles/changing-and-restoring-state.html">Changing and restoring state</a> and withr will also prove useful when we talk about testing in <a href="testing-basics.html"><span>Chapter&nbsp;13</span></a>.</p>
</section><section id="restore-state-with-baseon.exit" class="level3" data-number="6.5.2"><h3 data-number="6.5.2" class="anchored" data-anchor-id="restore-state-with-baseon.exit">
<span class="header-section-number">6.5.2</span> Restore state with <code>base::on.exit()</code>
</h3>
<p>Here is how the general “save, schedule restoration, change” pattern looks when using <code><a href="https://rdrr.io/r/base/on.exit.html">base::on.exit()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">z</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">...</span></span>
<span>  <span class="va">old</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, pty <span class="op">=</span> <span class="st">"s"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span><span class="va">old</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">...</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Other state changes aren’t available with that sort of setter and you must implement it yourself.</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">g</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, <span class="va">c</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">...</span></span>
<span>  <span class="va">scratch_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="va">scratch_file</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files.html">file.create</a></span><span class="op">(</span><span class="va">scratch_file</span><span class="op">)</span></span>
<span>  <span class="va">...</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that we specify <code>on.exit(..., add = TRUE)</code>, because you almost always want this behaviour, i.e.&nbsp;to <em>add</em> to the list of deferred cleanup tasks rather than to <em>replace</em> them entirely. This (and the default value of <code>after</code>) are related to our preference for <code><a href="https://withr.r-lib.org/reference/defer.html">withr::defer()</a></code>, when we’re willing to take a dependency on withr. These issues are explored in a <a href="https://withr.r-lib.org/articles/changing-and-restoring-state.html">withr vignette</a>.</p>
</section><section id="isolate-side-effects" class="level3" data-number="6.5.3"><h3 data-number="6.5.3" class="anchored" data-anchor-id="isolate-side-effects">
<span class="header-section-number">6.5.3</span> Isolate side effects</h3>
<p>Creating plots and printing output to the console are two other ways of affecting the global R environment. Often you can’t avoid these (because they’re important!) but it’s good practice to isolate them in functions that <strong>only</strong> produce output. This also makes it easier for other people to repurpose your work for new uses. For example, if you separate data preparation and plotting into two functions, others can use your data prep work (which is often the hardest part!) to create new visualisations.</p>
</section><section id="sec-code-onLoad-onAttach" class="level3" data-number="6.5.4"><h3 data-number="6.5.4" class="anchored" data-anchor-id="sec-code-onLoad-onAttach">
<span class="header-section-number">6.5.4</span> When you <strong>do</strong> need side-effects</h3>
<p>Occasionally, packages do need side-effects. This is most common if your package talks to an external system — you might need to do some initial setup when the package loads. To do that, you can use two special functions: <code>.onLoad()</code> and <code>.onAttach()</code>. These are called when the package is loaded and attached. You’ll learn about the distinction between the two in <a href="dependencies-mindset-background.html#sec-dependencies-attach-vs-load"><span>Section&nbsp;10.4</span></a>. For now, you should always use <code>.onLoad()</code> unless explicitly directed otherwise.</p>
<p>Some common uses of <code>.onLoad()</code> and <code>.onAttach()</code> are:</p>
<ul>
<li>
<p>To set custom options for your package with <code><a href="https://rdrr.io/r/base/options.html">options()</a></code>. To avoid conflicts with other packages, ensure that you prefix option names with the name of your package. Also be careful not to override options that the user has already set. Here’s a (highly redacted) version of dplyr’s <code>.onLoad()</code> function which sets an option that controls progress reporting:</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">.onLoad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">libname</span>, <span class="va">pkgname</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">op.dplyr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    dplyr.show_progress <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">toset</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">op.dplyr</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">toset</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span><span class="va">op.dplyr</span><span class="op">[</span><span class="va">toset</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This allows functions in dplyr to use <code>getOption("dplyr.show_progress")</code> to determine whether to show progress bars, relying on the fact that a sensible default value has already been set.</p>
</li>
</ul>
<!-- TODO: I don't think the option setting example is so great anymore. I lean towards replacement. Other possible examples of `.onLoad()` usage: Register S3 methods. Detect capabilities of the system or of other packages. --><ul>
<li>
<p>To display an informative message when the package is attached. This might make usage conditions clear or display package capabilities based on current system conditions. Startup messages are one place where you should use <code>.onAttach()</code> instead of <code>.onLoad()</code>. To display startup messages, always use <code><a href="https://rdrr.io/r/base/message.html">packageStartupMessage()</a></code>, and not <code><a href="https://rdrr.io/r/base/message.html">message()</a></code>. (This allows <code><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages()</a></code> to selectively suppress package startup messages).</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">.onAttach</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">libname</span>, <span class="va">pkgname</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html">packageStartupMessage</a></span><span class="op">(</span><span class="st">"Welcome to my package"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
</ul>
<p>As you can see in the examples, <code>.onLoad()</code> and <code>.onAttach()</code> are called with two arguments: <code>libname</code> and <code>pkgname</code>. They’re rarely used (they’re a holdover from the days when you needed to use <code><a href="https://rdrr.io/r/base/library.dynam.html">library.dynam()</a></code> to load compiled code). They give the path where the package is installed (the “library”), and the name of the package.</p>
<p>If you use <code>.onLoad()</code>, consider using <code>.onUnload()</code> to clean up any side effects. By convention, <code>.onLoad()</code> and friends are usually saved in a file called <code>R/zzz.R</code>. (Note that <code>.First.lib()</code> and <code>.Last.lib()</code> are old versions of <code>.onLoad()</code> and <code>.onUnload()</code> and should no longer be used.)</p>
<p>One especially hairy thing to do in a function like <code>.onLoad()</code> or <code>.onAttach()</code> is to change the state of the random number generator. Once upon a time, ggplot2 used <code><a href="https://rdrr.io/r/base/sample.html">sample()</a></code> when deciding whether to show a startup message, but only in interactive sessions. This, in turn, created a reproducibility puzzle for users who were using <code><a href="https://rdrr.io/r/base/Random.html">set.seed()</a></code> for their own purposes, prior to attaching ggplot2 with <code><a href="https://ggplot2.tidyverse.org">library(ggplot2)</a></code>, and running the code both interactively and noninteractively. The chosen solution was to wrap the offending startup code inside <code><a href="https://withr.r-lib.org/reference/with_seed.html">withr::with_preserve_seed()</a></code>, which leaves the user’s random seed as it found it.</p>
</section></section><section id="constant-health-checks" class="level2" data-number="6.6"><h2 data-number="6.6" class="anchored" data-anchor-id="constant-health-checks">
<span class="header-section-number">6.6</span> Constant health checks</h2>
<p>Here is a typical sequence of calls when using devtools for package development:</p>
<ol type="1">
<li>Edit one or more files below <code>R/</code>.</li>
<li>
<code>document()</code> (if you’ve made any changes that impact help files or NAMESPACE)</li>
<li><code>load_all()</code></li>
<li>Run some examples interactively.</li>
<li>
<code>test()</code> (or <code>test_active_file()</code>)</li>
<li><code>check()</code></li>
</ol>
<p>An interesting question is how frequently and rapidly you move through this development cycle. We often find ourselves running through the above sequence several times in an hour or in a day while adding or modifying a single function.</p>
<p>Those newer to package development might be most comfortable slinging R code and much less comfortable writing and compiling documentation, simulating package build &amp; installation, testing, and running <code>R CMD check</code>. And it is human nature to embrace the familiar and postpone the unfamiliar. This often leads to a dysfunctional workflow where the full sequence above unfolds infrequently, maybe once per month or every couple of months, very slowly and often with great pain:</p>
<ol type="1">
<li>Edit one or more files below <code>R/</code>.</li>
<li>Build, install, and use the package. Iterate occasionally with previous step.</li>
<li>Write documentation (once the code is “done”).</li>
<li>Write tests (once the code is “done”).</li>
<li>Run <code>R CMD check</code> right before submitting to CRAN or releasing in some other way.</li>
</ol>
<p>We’ve already talked about the value of fast feedback, in the context of <code>load_all()</code>. But this also applies to running <code>document()</code>, <code>test()</code>, and <code>check()</code>. There are defects you just can’t detect from using <code>load_all()</code> and running a few interactive examples that are immediately revealed by more formal checks. Finding and fixing 5 bugs, one at a time, right after you created each one is much easier than troubleshooting all 5 at once (possibly interacting with each other), weeks or months after you last touched the code.</p>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Submitting to CRAN
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you’re planning on submitting your package to CRAN, you must use only ASCII characters in your <code>.R</code> files. In practice, this means you are limited to the digits 0 to 9, lowercase letters ‘a’ to ‘z’, uppercase letters ‘A’ to ‘Z’, and common punctuation.</p>
<p>But sometimes you need to inline a small bit of character data that includes, e.g., a Greek letter (µ), an accented character (ü), or a symbol (30°). You can use any Unicode character as long as you specify it in the special Unicode escape <code>"\u1234"</code> format. The easiest way to find the correct code point is to use <code><a href="https://rdrr.io/pkg/stringi/man/stri_escape_unicode.html">stringi::stri_escape_unicode()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="st">"This is a bullet •"</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="st">"This is a bullet \u2022"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu">stringi</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/stringi/man/stri_escape_unicode.html">stri_escape_unicode</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; This is a bullet \u2022</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Sometimes you have the opposite problem. You don’t <em>intentionally</em> have any non-ASCII characters in your R code, but automated checks reveal that you do.</p>
<pre><code>W  checking R files for non-ASCII characters ...
   Found the following file with non-ASCII characters:
     foo.R
   Portable packages must use only ASCII characters in their R code,
   except perhaps in comments.
   Use \uxxxx escapes for other characters.</code></pre>
<p>The most common offenders are “curly” or “smart” single and double quotes that sneak in through copy/paste. The functions <code><a href="https://rdrr.io/r/tools/showNonASCII.html">tools::showNonASCII()</a></code> and <code>tools::showNonASCIIfile(file)</code> help you find the offending file(s) and line(s).</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/showNonASCII.html">showNonASCIIfile</a></span><span class="op">(</span><span class="st">"R/foo.R"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 666: #' If you&lt;e2&gt;&lt;80&gt;&lt;99&gt;ve copy/pasted quotes, watch out!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>


</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>不幸的是你不能在 <code>R/</code> 中使用子目录。 下一个最好的办法是使用公共前缀，例如 <code>abc-*.R</code>，来表示一组文件是相关的。<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>请参阅 <a href="https://github.com/r-lib/actions">GitHub Actions for the R language</a> repository 中的 <a href="https://github.com/r-lib/actions/tree/master/examples#commands-workflow">Commands workflow</a>。<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p><a href="https://mikemcquaid.com/2018/06/05/robot-pedantry-human-empathy/">Robot Pedantry, Human Empathy</a> 博客文章出色地总结了代码重新设计等自动化任务的好处。<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./package-within.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">The package within</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./data.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Data</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>